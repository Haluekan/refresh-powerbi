import pyodbc
import pandas as pd
import logging
import os
import time  # <--- ‚úÖ 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° time ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Retry

# ----------------------------------------------------------------------
# ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö Retry (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)
# ----------------------------------------------------------------------
MAX_RETRIES = 10       # ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
RETRY_DELAY = 60       # ‡∏£‡∏≠ 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà

# ----------------------------------------------------------------------
# 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏° (Absolute Paths)
# ----------------------------------------------------------------------

# ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå Log
log_file_path = r"D:\OneDrive - Datamars SA\mike\SO\DATA\2025\SO.log"

# ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
output_file_path = r"D:\OneDrive - Datamars SA\mike\SO\DATA\2025\Report - Sales Order 2025.xlsx"

# ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï
your_sheet_name = "Raw"

# ----------------------------------------------------------------------
# 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log
# ----------------------------------------------------------------------
logging.basicConfig(
    filename=log_file_path,
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    encoding='utf-8'
)

# ----------------------------------------------------------------------
# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Driver 17 + Timeout)
# ----------------------------------------------------------------------
connection_string = (
    "DRIVER={ODBC Driver 17 for SQL Server};"  
    "SERVER=sap-temp.datamars.local;"
    "DATABASE=DB_SAP_DMTHAI;"
    "UID=ro;"
    "PWD=DMquery!;"
    "Timeout=1800;" # 30 ‡∏ô‡∏≤‡∏ó‡∏µ
)

view_name = "vw_SalesOrder_2025"
sql_query = f"SELECT * FROM {view_name};"

# ----------------------------------------------------------------------
# 4. ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏´‡∏°‡∏î Excel ‡πÅ‡∏ó‡πâ + Chunking + Retry)
# ----------------------------------------------------------------------
logging.info(f"--- [!] ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÇ‡∏´‡∏°‡∏î: SalesRevenues + Retry System) ---")
logging.info(f"‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡πÑ‡∏õ‡∏ó‡∏µ‡πà: {log_file_path}")
logging.info(f"‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Excel ‡πÑ‡∏õ‡∏ó‡∏µ‡πà: {output_file_path}")

# ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏ô‡∏•‡∏π‡∏õ Retry
for attempt in range(1, MAX_RETRIES + 1):
    try:
        logging.info(f"üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà {attempt}/{MAX_RETRIES}...")
        logging.info(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...")
        
        with pyodbc.connect(connection_string) as connection:
            logging.info("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÉ‡∏ä‡πâ Driver 17)")
            logging.info(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å View: {view_name} (‡πÅ‡∏ö‡∏ö Chunking)...")
            
            # ‚úÖ Chunking: ‡∏ó‡∏¢‡∏≠‡∏¢‡∏î‡∏∂‡∏á‡∏ó‡∏µ‡∏•‡∏∞ 50,000 ‡πÅ‡∏ñ‡∏ß
            chunk_size = 50000
            data_iterator = pd.read_sql_query(sql_query, connection, chunksize=chunk_size)
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á List ‡πÑ‡∏ß‡πâ‡∏û‡∏±‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡πâ‡∏≠‡∏ô
            chunks_list = []
            total_rows = 0
            
            for i, chunk in enumerate(data_iterator):
                chunks_list.append(chunk)
                total_rows += len(chunk)
                logging.info(f"   ...‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà {i+1} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ({len(chunk)} ‡πÅ‡∏ñ‡∏ß) | ‡∏£‡∏ß‡∏° {total_rows} ‡πÅ‡∏ñ‡∏ß")
            
            if total_rows > 0:
                logging.info(f"‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå Excel...")
                
                # ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô DataFrame ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÉ‡∏ô Ram)
                full_df = pd.concat(chunks_list)
                
                # ‚úÖ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á Excel ‡∏à‡∏£‡∏¥‡∏á‡πÜ
                full_df.to_excel(
                    output_file_path, 
                    index=False, 
                    sheet_name=your_sheet_name,
                    engine='xlsxwriter'
                )
                
                logging.info(f"‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {total_rows} ‡πÅ‡∏ñ‡∏ß ‡∏•‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå '{output_file_path}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
                
                # ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ Break ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                logging.info("--- [!] ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à) --- \n")
                break
                
            else:
                logging.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô View '{view_name}' (0 ‡πÅ‡∏ñ‡∏ß)")
                # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà Error ‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                logging.info("--- [!] ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) --- \n")
                break

    except Exception as e:
        # ‚ùå ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
        logging.error(f"‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà {attempt}: {e}")
        
        if 'HY000' in str(e):
             logging.error("!!! Protocol Error: ‡πÄ‡∏ä‡πá‡∏Å Driver 17 ‡∏î‡πà‡∏ß‡∏ô !!!")
        
        if attempt < MAX_RETRIES:
            logging.info(f"‚è≥ ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å {RETRY_DELAY} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...")
            time.sleep(RETRY_DELAY)  # ‚úÖ ‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
        else:
            logging.critical(f"‚õî ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏Ñ‡∏£‡∏ö {MAX_RETRIES} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ç‡∏≠‡∏¢‡∏∏‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")
            logging.info("--- [!] ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß) --- \n")